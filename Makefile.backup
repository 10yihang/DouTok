# DouTok é¡¹ç›®ä¸€é”®å¯åŠ¨ Makefile
# ç¡®ä¿æ‰€æœ‰æœåŠ¡ä»¥æ­£ç¡®çš„é¡ºåºå¯åŠ¨

.PHONY: all dev start stop clean install-deps help frontend backend env status logs fix-docker diagnose reset-docker build-with-mirror build-images

# é»˜è®¤ç›®æ ‡ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡
all: start

# å¼€å‘ç¯å¢ƒå¯åŠ¨ï¼ˆæ¨èï¼‰
dev: check-deps build-images env backend frontend

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
start: check-deps build-images env-prod backend-prod frontend-prod

# æ„å»ºDockeré•œåƒ
build-images:
	@echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
	@echo "æ„å»º base-service..."
	@cd backend/baseService && docker build -t base-service . || echo "âš ï¸  base-service æ„å»ºå¤±è´¥ï¼Œè·³è¿‡..."
	@echo "æ„å»º sv-core-service..."
	@cd backend/shortVideoCoreService && docker build -t sv-core-service . || echo "âš ï¸  sv-core-service æ„å»ºå¤±è´¥ï¼Œè·³è¿‡..."
	@echo "æ„å»º sv-api-service..."
	@cd backend/shortVideoApiService && docker build -t sv-api-service . || echo "âš ï¸  sv-api-service æ„å»ºå¤±è´¥ï¼Œè·³è¿‡..."
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

# æ„å»ºå•ä¸ªé•œåƒï¼ˆç”¨äºå¼€å‘ï¼‰
build-base:
	@echo "ğŸ”¨ æ„å»º base-service..."
	@cd backend/baseService && docker build -t base-service .

build-core:
	@echo "ğŸ”¨ æ„å»º sv-core-service..."
	@cd backend/shortVideoCoreService && docker build -t sv-core-service .

build-api:
	@echo "ğŸ”¨ æ„å»º sv-api-service..."
	@cd backend/shortVideoApiService && docker build -t sv-api-service .

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@cd env && docker-compose -f backends.yml down || true
	@cd env && docker-compose -f trace.yml down || true
	@cd env && docker-compose -f rocketmq.yml down || true
	@cd env && docker-compose -f basic.yml down || true
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# æ¸…ç†ç¯å¢ƒ
clean: stop
	@echo "ğŸ§¹ æ¸…ç†Dockerèµ„æº..."
	@docker system prune -f || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ£€æŸ¥ä¾èµ–
check-deps:
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
	@command -v docker >/dev/null 2>&1 || { echo "âŒ è¯·å…ˆå®‰è£… Docker"; exit 1; }
	@command -v docker-compose >/dev/null 2>&1 || { echo "âŒ è¯·å…ˆå®‰è£… Docker Compose"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "âŒ è¯·å…ˆå®‰è£… Node.js"; exit 1; }
	@command -v npm >/dev/null 2>&1 || { echo "âŒ è¯·å…ˆå®‰è£… npm"; exit 1; }
	@command -v go >/dev/null 2>&1 || { echo "âŒ è¯·å…ˆå®‰è£… Go"; exit 1; }
	@echo "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"

# å®‰è£…å‰ç«¯ä¾èµ–
install-deps:
	@echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
	@cd frontend/doutok && npm install
	@echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"

# å¯åŠ¨åŸºç¡€ç¯å¢ƒï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰
env:
	@echo "ğŸš€ å¯åŠ¨åŸºç¡€ç¯å¢ƒ..."
	@cd env && make basic
	@echo "â±ï¸  ç­‰å¾…åŸºç¡€æœåŠ¡å¯åŠ¨..."
	@sleep 10
	@cd env && make mq
	@echo "â±ï¸  ç­‰å¾…æ¶ˆæ¯é˜Ÿåˆ—å¯åŠ¨..."
	@sleep 5
	@cd env && make trace
	@echo "â±ï¸  ç­‰å¾…é“¾è·¯è¿½è¸ªæœåŠ¡å¯åŠ¨..."
	@sleep 5
	@echo "âœ… åŸºç¡€ç¯å¢ƒå¯åŠ¨å®Œæˆ"

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
env-prod: env

# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
backend:
	@echo "ğŸ”§ å¯åŠ¨åç«¯æœåŠ¡..."
	@echo " å¯åŠ¨åç«¯å®¹å™¨..."
	@cd env && docker-compose -f backends.yml up -d || echo "âš ï¸  éƒ¨åˆ†åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
	@echo "â±ï¸  ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
	@sleep 15
	@echo "âœ… åç«¯æœåŠ¡å¯åŠ¨å®Œæˆ"

# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
backend-prod: backend

# å¯åŠ¨å‰ç«¯æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
frontend:
	@echo "ğŸ¨ å¯åŠ¨å‰ç«¯æœåŠ¡..."
	@echo "ğŸ“¦ æ£€æŸ¥å‰ç«¯ä¾èµ–..."
	@cd frontend/doutok && npm install
	@echo "ğŸš€ å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
	@cd frontend/doutok && npm run dev &
	@echo "âœ… å‰ç«¯æœåŠ¡å¯åŠ¨å®Œæˆï¼Œè®¿é—®åœ°å€ï¼šhttp://localhost:23000"

# å¯åŠ¨å‰ç«¯æœåŠ¡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
frontend-prod:
	@echo "ğŸ¨ æ„å»ºå¹¶å¯åŠ¨å‰ç«¯æœåŠ¡..."
	@cd frontend/doutok && npm install
	@cd frontend/doutok && npm run build
	@cd frontend/doutok && npm run start &
	@echo "âœ… å‰ç«¯ç”Ÿäº§æœåŠ¡å¯åŠ¨å®Œæˆï¼Œè®¿é—®åœ°å€ï¼šhttp://localhost:3000"

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥..."
	@echo "\nğŸ³ Docker å®¹å™¨çŠ¶æ€ï¼š"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
	@echo "\nğŸŒ ç«¯å£ä½¿ç”¨æƒ…å†µï¼š"
	@netstat -tlnp 2>/dev/null | grep -E ":3000|:23000|:8080|:3306|:6379|:9092" | head -10 || echo "æ— æ³•è·å–ç«¯å£ä¿¡æ¯"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“‹ æœ€è¿‘çš„æœåŠ¡æ—¥å¿—..."
	@echo "åç«¯æœåŠ¡æ—¥å¿—ï¼š"
	@cd env && docker-compose -f backends.yml logs --tail=50 || true
	@echo "\nå‰ç«¯æ—¥å¿—è¯·æŸ¥çœ‹ç»ˆç«¯è¾“å‡º"

# ç½‘ç»œè¯Šæ–­å’Œä¿®å¤
diagnose:
	@echo "ğŸ” è¯Šæ–­ç½‘ç»œå’ŒDockerçŠ¶æ€..."
	@echo "\nğŸ“Š Docker çŠ¶æ€ï¼š"
	@docker version 2>/dev/null || echo "âŒ Dockeræœªè¿è¡Œæˆ–æœªå®‰è£…"
	@echo "\nğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•ï¼š"
	@curl -s --connect-timeout 5 https://registry-1.docker.io/v2/ >/dev/null && echo "âœ… Docker Hubè¿æ¥æ­£å¸¸" || echo "âŒ Docker Hubè¿æ¥å¤±è´¥"
	@echo "\nğŸ³ Dockeré•œåƒåˆ—è¡¨ï¼š"
	@docker images | grep -E "(base-service|sv-.*-service)" || echo "âš ï¸  æœªæ‰¾åˆ°æœ¬åœ°é•œåƒ"
	@echo "\nğŸ’¡ è§£å†³å»ºè®®ï¼š"
	@echo "1. å¦‚æœDocker Hubè¿æ¥å¤±è´¥ï¼Œè¯·é…ç½®é•œåƒåŠ é€Ÿå™¨"
	@echo "2. å¦‚æœé•œåƒä¸å­˜åœ¨ï¼Œè¯·è¿è¡Œ 'make build-images'"
	@echo "3. å¦‚æœæ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ Go ç¯å¢ƒå’Œç½‘ç»œ"

# é…ç½®Dockeré•œåƒåŠ é€Ÿå™¨
setup-docker-mirror:
	@echo "ğŸ”§ é…ç½®Dockeré•œåƒåŠ é€Ÿå™¨..."
	@echo "è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
	@echo "sudo tee /etc/docker/daemon.json <<-'EOF'"
	@echo "{"
	@echo '  "registry-mirrors": ['
	@echo '    "https://docker.mirrors.ustc.edu.cn",'
	@echo '    "https://hub-mirror.c.163.com",'
	@echo '    "https://mirror.baidubce.com"'
	@echo "  ]"
	@echo "}"
	@echo "EOF"
	@echo ""
	@echo "ç„¶åé‡å¯DockeræœåŠ¡ï¼š"
	@echo "sudo systemctl restart docker"

# ä»…å¯åŠ¨åŸºç¡€ç¯å¢ƒï¼Œè·³è¿‡åç«¯
dev-frontend-only: check-deps env frontend
	@echo "âœ… ä»…å¯åŠ¨å‰ç«¯å’ŒåŸºç¡€ç¯å¢ƒå®Œæˆ"

# å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒ
rebuild-images:
	@echo "ï¿½ å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰é•œåƒ..."
	@cd backend/baseService && docker build --no-cache -t base-service . || echo "âš ï¸  base-service é‡æ–°æ„å»ºå¤±è´¥"
	@cd backend/shortVideoCoreService && docker build --no-cache -t sv-core-service . || echo "âš ï¸  sv-core-service é‡æ–°æ„å»ºå¤±è´¥"
	@cd backend/shortVideoApiService && docker build --no-cache -t sv-api-service . || echo "âš ï¸  sv-api-service é‡æ–°æ„å»ºå¤±è´¥"
	@echo "âœ… é•œåƒé‡æ–°æ„å»ºå®Œæˆ"

# é‡å¯æ‰€æœ‰æœåŠ¡
restart: stop
	@echo "ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡..."
	@sleep 3
	@make dev

# å¿«é€Ÿå¯åŠ¨ï¼ˆè·³è¿‡ä¾èµ–æ£€æŸ¥ï¼‰
quick:
	@echo "âš¡ å¿«é€Ÿå¯åŠ¨..."
	@make env
	@make backend
	@make frontend

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ“– DouTok é¡¹ç›® Makefile ä½¿ç”¨è¯´æ˜"
	@echo ""
	@echo "ğŸ¯ ä¸»è¦å‘½ä»¤ï¼š"
	@echo "  make dev          - å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆæ¨èï¼‰"
	@echo "  make start        - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "  make stop         - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make restart      - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo ""
	@echo "ï¿½ æ„å»ºå‘½ä»¤ï¼š"
	@echo "  make build-images - æ„å»ºæ‰€æœ‰Dockeré•œåƒ"
	@echo "  make build-base   - æ„å»º base-service é•œåƒ"
	@echo "  make build-core   - æ„å»º sv-core-service é•œåƒ"
	@echo "  make build-api    - æ„å»º sv-api-service é•œåƒ"
	@echo ""
	@echo "ï¿½ğŸ”§ å…¶ä»–å‘½ä»¤ï¼š"
	@echo "  make env          - ä»…å¯åŠ¨åŸºç¡€ç¯å¢ƒ"
	@echo "  make backend      - ä»…å¯åŠ¨åç«¯æœåŠ¡"
	@echo "  make frontend     - ä»…å¯åŠ¨å‰ç«¯æœåŠ¡"
	@echo "  make status       - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make logs         - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  make clean        - æ¸…ç†ç¯å¢ƒ"
	@echo "  make install-deps - å®‰è£…ä¾èµ–"
	@echo "  make quick        - å¿«é€Ÿå¯åŠ¨ï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰"
	@echo "  make diagnose     - è¯Šæ–­ç½‘ç»œå’ŒDockerçŠ¶æ€"
	@echo ""
	@echo "ğŸŒ æœåŠ¡åœ°å€ï¼š"
	@echo "  å‰ç«¯å¼€å‘ç¯å¢ƒ: http://localhost:23000"
	@echo "  å‰ç«¯ç”Ÿäº§ç¯å¢ƒ: http://localhost:3000"
	@echo "  åç«¯API:     http://localhost:22000"
	@echo ""
	@echo "ğŸ’¡ é‡åˆ°ç½‘ç»œé—®é¢˜æ—¶ï¼š"
	@echo "  1. make diagnose          # è¯Šæ–­é—®é¢˜"
	@echo "  2. make setup-docker-mirror  # é…ç½®é•œåƒåŠ é€Ÿå™¨"
	@echo "  3. make rebuild-images    # é‡æ–°æ„å»ºé•œåƒ"
	@echo ""
	@echo "ğŸ’¡ é¦–æ¬¡ä½¿ç”¨å»ºè®®ï¼š"
	@echo "  1. make install-deps  # å®‰è£…ä¾èµ–"
	@echo "  2. make build-images  # æ„å»ºé•œåƒ"
	@echo "  3. make dev          # å¯åŠ¨å¼€å‘ç¯å¢ƒ"

# Dockerä¿®å¤å’Œè¯Šæ–­
fix-docker:
	@echo "ğŸ”§ ä¿®å¤Dockeré•œåƒé—®é¢˜..."
	@echo "1. æ¸…ç†Dockerç¼“å­˜..."
	@docker system prune -af --volumes || true
	@echo "2. æ¸…ç†æ„å»ºç¼“å­˜..."
	@docker builder prune -af || true
	@echo "3. é‡å¯DockeræœåŠ¡..."
	@sudo systemctl restart docker || true
	@echo "4. ç­‰å¾…DockeræœåŠ¡å¯åŠ¨..."
	@sleep 5
	@echo "âœ… Dockerä¿®å¤å®Œæˆ"

# å®Œå…¨é‡ç½®Dockerç¯å¢ƒ
reset-docker:
	@echo "âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰Dockeræ•°æ®ï¼"
	@read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "ğŸ”¥ å®Œå…¨é‡ç½®Dockerç¯å¢ƒ..."
	@docker stop $$(docker ps -aq) 2>/dev/null || true
	@docker rm $$(docker ps -aq) 2>/dev/null || true
	@docker rmi $$(docker images -q) 2>/dev/null || true
	@docker volume rm $$(docker volume ls -q) 2>/dev/null || true
	@docker network rm $$(docker network ls -q) 2>/dev/null || true
	@docker system prune -af --volumes
	@sudo systemctl restart docker
	@echo "âœ… Dockerç¯å¢ƒé‡ç½®å®Œæˆ"

# ä½¿ç”¨å›½å†…é•œåƒæºæ„å»º
build-with-mirror:
	@echo "ğŸ‡¨ğŸ‡³ ä½¿ç”¨å›½å†…é•œåƒæºæ„å»º..."
	@echo "é…ç½®Dockeré•œåƒåŠ é€Ÿå™¨..."
	@sudo mkdir -p /etc/docker
	@sudo tee /etc/docker/daemon.json > /dev/null <<-'EOF'
	{
	  "registry-mirrors": [
	    "https://docker.mirrors.ustc.edu.cn",
	    "https://hub-mirror.c.163.com",
	    "https://mirror.baidubce.com"
	  ],
	  "insecure-registries": [],
	  "debug": false,
	  "experimental": false,
	  "features": {
	    "buildkit": true
	  }
	}
	EOF
	@sudo systemctl daemon-reload
	@sudo systemctl restart docker
	@echo "ç­‰å¾…Dockeré‡å¯..."
	@sleep 10
	@echo "âœ… é•œåƒåŠ é€Ÿå™¨é…ç½®å®Œæˆ"
